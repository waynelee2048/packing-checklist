<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#374151">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="æ‰“åŒ…æ¸…å–®">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>æ‰“åŒ…æ¸…å–®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC3tTgAIVm0qz5irkqb7AkjwY7FOMJz4RM",
      authDomain: "packing-8b3de.firebaseapp.com",
      databaseURL: "https://packing-8b3de-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "packing-8b3de",
      storageBucket: "packing-8b3de.firebasestorage.app",
      messagingSenderId: "109766093944",
      appId: "1:109766093944:web:35b8d72158750ab522d18d",
      measurementId: "G-GRY36B729W"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // æš´éœ²çµ¦å…¨åŸŸä½¿ç”¨
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.googleProvider = provider;
    window.firebaseSignInWithPopup = signInWithPopup;
    window.firebaseSignOut = signOut;
    window.firebaseOnAuthStateChanged = onAuthStateChanged;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseOnValue = onValue;

    // é€šçŸ¥ä¸»ç¨‹å¼ Firebase å·²å°±ç·’
    window.dispatchEvent(new Event('firebase-ready'));
  </script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 0); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; display: inline-block; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app"></div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // è³‡æ–™ç®¡ç†ï¼ˆFirebase Realtime Databaseï¼‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const STORAGE_KEY = 'packing-checklist-data';

    const defaultData = {
      itemLibrary: [
        { id: 1, name: 'éŒ¢åŒ…', category: 'å¿…å‚™', note: 'æ”¾åœ¨ç„é—œæŠ½å±œ' },
        { id: 2, name: 'é‘°åŒ™', category: 'å¿…å‚™', note: 'å¤§é–€+æ©Ÿè»Š' },
        { id: 3, name: 'æ‰‹æ©Ÿ', category: 'å¿…å‚™', note: '' },
        { id: 4, name: 'æ‚ éŠå¡', category: 'å¿…å‚™', note: 'è¨˜å¾—åŠ å€¼' },
        { id: 5, name: 'è€³æ©Ÿ', category: 'é›»å­ç”¢å“', note: 'å……é›»ç›’åœ¨æ›¸æ¡Œ' },
        { id: 6, name: 'è¡Œå‹•é›»æº', category: 'é›»å­ç”¢å“', note: 'å‡ºé–€å‰ç¢ºèªé›»é‡' },
        { id: 7, name: 'å……é›»ç·š', category: 'é›»å­ç”¢å“', note: 'Type-C' },
        { id: 8, name: 'å£ç½©', category: 'å€‹äººç‰©å“', note: 'å‚™ç”¨æ”¾åŒ…åŒ…å…§è¢‹' },
        { id: 9, name: 'é¢ç´™', category: 'å€‹äººç‰©å“', note: '' },
        { id: 10, name: 'æ°´å£º', category: 'å€‹äººç‰©å“', note: 'è£æ»¿æ°´' },
        { id: 11, name: 'é›¨å‚˜', category: 'è¦–å¤©æ°£', note: 'æ‘ºç–Šå‚˜åœ¨é–€å£' },
        { id: 12, name: 'è­·ç…§', category: 'æ—…è¡Œ', note: 'æ•ˆæœŸåˆ° 2027/05' },
        { id: 13, name: 'æ›æ´—è¡£ç‰©', category: 'æ—…è¡Œ', note: 'ä¾å¤©æ•¸æº–å‚™' },
      ],
      lists: [
        { id: 1, name: 'æ—¥å¸¸å‡ºé–€', icon: 'ğŸš¶', items: [1, 2, 3, 4, 8, 9], checkedItems: [] },
        { id: 2, name: 'ä¸Šç­é€šå‹¤', icon: 'ğŸ’¼', items: [1, 2, 3, 4, 5, 6, 7, 8], checkedItems: [] },
      ],
      activeListId: 1
    };

    const categories = ['å¿…å‚™', 'é›»å­ç”¢å“', 'å€‹äººç‰©å“', 'è¦–å¤©æ°£', 'æ—…è¡Œ', 'é‹å‹•'];
    const iconOptions = ['ğŸ“‹', 'ğŸš¶', 'ğŸ’¼', 'âœˆï¸', 'ğŸƒ', 'ğŸ’', 'ğŸ–ï¸', 'ğŸ•ï¸', 'ğŸ¯', 'ğŸ›’'];

    // ç”¨æˆ¶ç‹€æ…‹
    let currentUser = null;
    let firebaseReady = false;
    let unsubscribeDb = null;
    let syncStatus = 'offline'; // 'offline' | 'syncing' | 'synced' | 'error'

    // ä¿®å¾© Firebase è³‡æ–™æ ¼å¼ï¼ˆç©ºé™£åˆ—æœƒè¢«å­˜æˆ nullï¼‰
    function sanitizeData(data) {
      if (!data) return defaultData;

      return {
        itemLibrary: Array.isArray(data.itemLibrary) ? data.itemLibrary : defaultData.itemLibrary,
        lists: Array.isArray(data.lists) ? data.lists.map(list => ({
          ...list,
          items: Array.isArray(list.items) ? list.items : [],
          checkedItems: Array.isArray(list.checkedItems) ? list.checkedItems : []
        })) : defaultData.lists,
        activeListId: data.activeListId || defaultData.activeListId
      };
    }

    // å¾ localStorage è¼‰å…¥ï¼ˆé›¢ç·šå‚™ä»½ï¼‰
    function loadFromLocal() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          return sanitizeData(JSON.parse(saved));
        }
      } catch (e) {
        console.error('è¼‰å…¥æœ¬åœ°è³‡æ–™å¤±æ•—', e);
      }
      return defaultData;
    }

    // å„²å­˜åˆ° localStorageï¼ˆé›¢ç·šå‚™ä»½ï¼‰
    function saveToLocal(data) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('å„²å­˜æœ¬åœ°è³‡æ–™å¤±æ•—', e);
      }
    }

    // å„²å­˜åˆ° Firebase
    function saveData(data) {
      saveToLocal(data); // ç¸½æ˜¯å…ˆå­˜æœ¬åœ°

      if (currentUser && firebaseReady) {
        syncStatus = 'syncing';
        render();
        const userRef = window.firebaseRef(window.firebaseDb, 'users/' + currentUser.uid);
        window.firebaseSet(userRef, data)
          .then(() => {
            syncStatus = 'synced';
            render();
          })
          .catch(err => {
            console.error('Firebase å„²å­˜å¤±æ•—', err);
            syncStatus = 'error';
            render();
          });
      }
    }

    // ç›£è½ Firebase è³‡æ–™è®ŠåŒ–
    function subscribeToFirebase(uid) {
      if (unsubscribeDb) unsubscribeDb();

      const userRef = window.firebaseRef(window.firebaseDb, 'users/' + uid);
      unsubscribeDb = window.firebaseOnValue(userRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          state = sanitizeData(data);
          saveToLocal(state);
          syncStatus = 'synced';
        } else {
          // é›²ç«¯æ²’è³‡æ–™ï¼Œä¸Šå‚³æœ¬åœ°è³‡æ–™
          saveData(state);
        }
        render();
      }, (error) => {
        console.error('Firebase è®€å–å¤±æ•—', error);
        syncStatus = 'error';
        render();
      });
    }

    // Google ç™»å…¥
    function handleLogin() {
      if (!firebaseReady) {
        alert('Firebase å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦');
        return;
      }
      window.firebaseSignInWithPopup(window.firebaseAuth, window.googleProvider)
        .catch(err => {
          console.error('ç™»å…¥å¤±æ•—', err);
          alert('ç™»å…¥å¤±æ•—ï¼š' + err.message);
        });
    }

    // ç™»å‡º
    function handleLogout() {
      if (unsubscribeDb) {
        unsubscribeDb();
        unsubscribeDb = null;
      }
      window.firebaseSignOut(window.firebaseAuth)
        .then(() => {
          currentUser = null;
          syncStatus = 'offline';
          render();
        })
        .catch(err => {
          console.error('ç™»å‡ºå¤±æ•—', err);
        });
    }

    // åˆå§‹åŒ– Firebase èªè­‰ç›£è½
    function initFirebaseAuth() {
      window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
        currentUser = user;
        if (user) {
          subscribeToFirebase(user.uid);
        } else {
          syncStatus = 'offline';
          if (unsubscribeDb) {
            unsubscribeDb();
            unsubscribeDb = null;
          }
        }
        render();
      });
    }

    // ç­‰å¾… Firebase å°±ç·’
    window.addEventListener('firebase-ready', () => {
      firebaseReady = true;
      initFirebaseAuth();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let state = loadFromLocal();
    let currentView = 'checklist'; // 'checklist' | 'lists' | 'library' | 'addItems'
    let editingItemId = null;
    let editingListId = null;
    let expandedNotes = [];

    function getActiveList() {
      const lists = state.lists || [];
      const list = lists.find(l => l.id === state.activeListId);
      if (!list) return null;
      // ç¢ºä¿ items å’Œ checkedItems æ˜¯é™£åˆ—
      return {
        ...list,
        items: Array.isArray(list.items) ? list.items : [],
        checkedItems: Array.isArray(list.checkedItems) ? list.checkedItems : []
      };
    }

    function getListItems() {
      const list = getActiveList();
      if (!list) return [];
      const itemLibrary = state.itemLibrary || [];
      return (list.items || [])
        .map(id => itemLibrary.find(item => item.id === id))
        .filter(Boolean);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ“ä½œå‡½æ•¸
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleItemCheck(itemId) {
      state.lists = state.lists.map(list => {
        if (list.id !== state.activeListId) return list;
        const isChecked = list.checkedItems.includes(itemId);
        return {
          ...list,
          checkedItems: isChecked
            ? list.checkedItems.filter(id => id !== itemId)
            : [...list.checkedItems, itemId]
        };
      });
      saveData(state);
      render();
    }

    function resetChecks() {
      state.lists = state.lists.map(list =>
        list.id === state.activeListId ? { ...list, checkedItems: [] } : list
      );
      saveData(state);
      render();
    }

    function checkAll() {
      const list = getActiveList();
      if (list) {
        state.lists = state.lists.map(l =>
          l.id === state.activeListId ? { ...l, checkedItems: [...l.items] } : l
        );
        saveData(state);
        render();
      }
    }

    function selectList(listId) {
      state.activeListId = listId;
      currentView = 'checklist';
      saveData(state);
      render();
    }

    function addNewList(name, icon) {
      const newList = {
        id: Date.now(),
        name: name.trim(),
        icon: icon,
        items: [],
        checkedItems: []
      };
      state.lists.push(newList);
      state.activeListId = newList.id;
      saveData(state);
      currentView = 'checklist';
      render();
    }

    function deleteList(listId) {
      if (state.lists.length <= 1) return;
      state.lists = state.lists.filter(l => l.id !== listId);
      if (state.activeListId === listId) {
        state.activeListId = state.lists[0].id;
      }
      saveData(state);
      render();
    }

    function toggleItemInList(itemId) {
      state.lists = state.lists.map(list => {
        if (list.id !== state.activeListId) return list;
        const hasItem = list.items.includes(itemId);
        return {
          ...list,
          items: hasItem
            ? list.items.filter(id => id !== itemId)
            : [...list.items, itemId],
          checkedItems: hasItem
            ? list.checkedItems.filter(id => id !== itemId)
            : list.checkedItems
        };
      });
      saveData(state);
      render();
    }

    function addItemToLibrary(name, category, note) {
      const newItem = {
        id: Date.now(),
        name: name.trim(),
        category: category,
        note: note.trim()
      };
      state.itemLibrary.push(newItem);
      saveData(state);
      render();
    }

    function updateItem(itemId, name, category, note) {
      state.itemLibrary = state.itemLibrary.map(item =>
        item.id === itemId ? { ...item, name, category, note } : item
      );
      editingItemId = null;
      saveData(state);
      render();
    }

    function deleteItemFromLibrary(itemId) {
      state.itemLibrary = state.itemLibrary.filter(item => item.id !== itemId);
      state.lists = state.lists.map(list => ({
        ...list,
        items: list.items.filter(id => id !== itemId),
        checkedItems: list.checkedItems.filter(id => id !== itemId)
      }));
      saveData(state);
      render();
    }

    function toggleNoteExpand(itemId) {
      if (expandedNotes.includes(itemId)) {
        expandedNotes = expandedNotes.filter(id => id !== itemId);
      } else {
        expandedNotes.push(itemId);
      }
      render();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ¸²æŸ“å‡½æ•¸
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function render() {
      const app = document.getElementById('app');

      if (currentView === 'checklist') {
        app.innerHTML = renderChecklist();
      } else if (currentView === 'lists') {
        app.innerHTML = renderListsView();
      } else if (currentView === 'library') {
        app.innerHTML = renderLibraryView();
      } else if (currentView === 'addItems') {
        app.innerHTML = renderAddItemsView();
      }

      attachEventListeners();
    }

    // æ¸²æŸ“åŒæ­¥ç‹€æ…‹åœ–ç¤º
    function renderSyncStatus() {
      const statusConfig = {
        offline: { icon: 'â—‹', color: 'text-gray-400', title: 'é›¢ç·šæ¨¡å¼' },
        syncing: { icon: 'â†»', color: 'text-yellow-300 animate-spin', title: 'åŒæ­¥ä¸­...' },
        synced: { icon: 'â—', color: 'text-green-400', title: 'å·²åŒæ­¥' },
        error: { icon: '!', color: 'text-red-400', title: 'åŒæ­¥å¤±æ•—' }
      };
      const status = statusConfig[syncStatus] || statusConfig.offline;
      return `<span class="${status.color}" title="${status.title}">${status.icon}</span>`;
    }

    // æ¸²æŸ“ç”¨æˆ¶å€å¡Š
    function renderUserSection() {
      if (currentUser) {
        return `
          <div class="flex items-center gap-2 px-3 py-2 bg-gray-600 rounded-lg">
            <img src="${currentUser.photoURL || ''}" alt="" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
            <span class="text-sm max-w-[80px] truncate">${currentUser.displayName || currentUser.email}</span>
            ${renderSyncStatus()}
            <button onclick="handleLogout()" class="text-xs text-gray-300 hover:text-white ml-1">ç™»å‡º</button>
          </div>
        `;
      }
      return `
        <button onclick="handleLogin()" class="flex items-center gap-2 px-3 py-2 bg-white text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-100">
          <svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          ç™»å…¥
        </button>
      `;
    }

    function renderChecklist() {
      const list = getActiveList();
      const items = getListItems();
      const checkedCount = list ? (list.checkedItems || []).length : 0;
      const totalCount = items.length;
      const allChecked = totalCount > 0 && checkedCount === totalCount;
      const progress = totalCount > 0 ? (checkedCount / totalCount) * 100 : 0;

      return `
        <div class="flex flex-col h-screen">
          <!-- é ‚éƒ¨å°èˆª -->
          <div class="bg-gray-700 text-white px-4 py-3 safe-top">
            <!-- ç”¨æˆ¶ç‹€æ…‹åˆ— -->
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm text-gray-300">æ‰“åŒ…æ¸…å–®</div>
              ${renderUserSection()}
            </div>
            <div class="flex items-center justify-between">
              <button onclick="currentView='lists'; render();" class="p-2 -ml-2 rounded-lg hover:bg-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
              </button>
              <div class="text-center">
                <div class="text-lg font-bold flex items-center justify-center">
                  <span class="mr-2">${list?.icon || 'ğŸ“‹'}</span>
                  ${list?.name || 'æ¸…å–®'}
                </div>
              </div>
              <button onclick="currentView='addItems'; render();" class="p-2 -mr-2 rounded-lg hover:bg-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
              </button>
            </div>
            <!-- é€²åº¦æ¢ -->
            ${totalCount > 0 ? `
              <div class="mt-3">
                <div class="flex justify-between text-xs text-gray-300 mb-1">
                  <span>å®Œæˆé€²åº¦</span>
                  <span>${checkedCount}/${totalCount}</span>
                </div>
                <div class="h-2 bg-gray-600 rounded-full overflow-hidden">
                  <div class="h-full bg-white transition-all duration-300" style="width: ${progress}%"></div>
                </div>
              </div>
            ` : ''}
          </div>

          <!-- æ¸…å–®å…§å®¹ -->
          <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
            ${items.length === 0 ? `
              <div class="text-center py-16 text-gray-400">
                <div class="text-5xl mb-4">ğŸ“­</div>
                <div class="text-lg mb-2">æ¸…å–®æ˜¯ç©ºçš„</div>
                <button onclick="currentView='addItems'; render();" class="text-gray-500 underline">
                  å¾ç‰©å“åº«åŠ å…¥ç‰©å“
                </button>
              </div>
            ` : `
              <div class="space-y-2">
                ${items.map(item => {
                  const isChecked = (list.checkedItems || []).includes(item.id);
                  const hasNote = item.note && item.note.trim();
                  const isNoteExpanded = expandedNotes.includes(item.id);
                  return `
                    <div class="group">
                      <div onclick="toggleItemCheck(${item.id})"
                           class="flex items-center p-4 bg-white rounded-xl shadow-sm active:bg-gray-50 transition-all
                                  ${isChecked ? 'bg-gray-50' : ''} ${isNoteExpanded ? 'rounded-b-none' : ''}">
                        <div class="w-6 h-6 border-2 rounded-full mr-4 flex items-center justify-center flex-shrink-0 transition-colors
                                    ${isChecked ? 'border-gray-600 bg-gray-600' : 'border-gray-300'}">
                          ${isChecked ? '<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="${isChecked ? 'line-through text-gray-400' : 'text-gray-800'} text-lg">
                            ${item.name}
                          </div>
                          <div class="text-xs text-gray-400">${item.category}</div>
                        </div>
                        ${hasNote ? `
                          <button onclick="event.stopPropagation(); toggleNoteExpand(${item.id});"
                                  class="p-2 rounded-lg ${isNoteExpanded ? 'bg-gray-200 text-gray-600' : 'text-gray-400'}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                            </svg>
                          </button>
                        ` : ''}
                      </div>
                      ${hasNote && isNoteExpanded ? `
                        <div class="px-4 py-3 bg-gray-50 border-t border-gray-100 rounded-b-xl">
                          <div class="flex items-start text-sm text-gray-600">
                            <span class="mr-2">ğŸ“</span>
                            <span>${item.note}</span>
                          </div>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>

          <!-- åº•éƒ¨æŒ‰éˆ• -->
          ${items.length > 0 ? `
            <div class="p-4 bg-white border-t border-gray-200 safe-bottom">
              <div class="flex gap-3">
                <button onclick="resetChecks()"
                        class="flex-1 py-3 text-gray-600 border border-gray-300 rounded-xl font-medium active:bg-gray-100">
                  é‡è¨­
                </button>
                <button onclick="checkAll()"
                        ${allChecked ? 'disabled' : ''}
                        class="flex-1 py-3 rounded-xl font-medium transition-colors
                               ${allChecked ? 'bg-gray-200 text-gray-400' : 'bg-gray-700 text-white active:bg-gray-800'}">
                  ${allChecked ? 'âœ“ æº–å‚™å®Œæˆï¼' : 'å…¨éƒ¨ç¢ºèª'}
                </button>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderListsView() {
      return `
        <div class="flex flex-col h-screen">
          <!-- é ‚éƒ¨ -->
          <div class="bg-gray-700 text-white px-4 py-3">
            <div class="flex items-center justify-between">
              <button onclick="currentView='checklist'; render();" class="p-2 -ml-2 rounded-lg hover:bg-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
              </button>
              <div class="text-lg font-bold">æˆ‘çš„æ¸…å–®</div>
              <button onclick="currentView='library'; render();" class="p-2 -mr-2 rounded-lg hover:bg-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- æ¸…å–®åˆ—è¡¨ -->
          <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
            <div class="space-y-2">
              ${(state.lists || []).map(list => {
                const itemCount = (list.items || []).length;
                const checkedCount = (list.checkedItems || []).length;
                const isActive = list.id === state.activeListId;
                return `
                  <div onclick="selectList(${list.id})"
                       class="flex items-center p-4 bg-white rounded-xl shadow-sm active:bg-gray-50 ${isActive ? 'ring-2 ring-gray-400' : ''}">
                    <span class="text-2xl mr-3">${list.icon}</span>
                    <div class="flex-1">
                      <div class="font-medium text-gray-800">${list.name}</div>
                      <div class="text-sm text-gray-400">${checkedCount}/${itemCount} å·²ç¢ºèª</div>
                    </div>
                    ${state.lists.length > 1 ? `
                      <button onclick="event.stopPropagation(); if(confirm('ç¢ºå®šåˆªé™¤æ­¤æ¸…å–®ï¼Ÿ')) deleteList(${list.id});"
                              class="p-2 text-gray-400 hover:text-red-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                      </button>
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>

            <!-- æ–°å¢æ¸…å–® -->
            <div class="mt-4 p-4 bg-white rounded-xl shadow-sm">
              <div class="text-sm text-gray-500 mb-3">æ–°å¢æ¸…å–®</div>
              <div class="flex gap-1 mb-3 flex-wrap">
                ${iconOptions.map(icon => `
                  <button onclick="document.getElementById('newListIcon').value='${icon}'; this.parentElement.querySelectorAll('button').forEach(b=>b.classList.remove('bg-gray-200')); this.classList.add('bg-gray-200');"
                          class="w-10 h-10 rounded-lg text-xl hover:bg-gray-100">${icon}</button>
                `).join('')}
              </div>
              <input type="hidden" id="newListIcon" value="ğŸ“‹">
              <div class="flex gap-2">
                <input type="text" id="newListName" placeholder="æ¸…å–®åç¨±..."
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-gray-500">
                <button onclick="const name=document.getElementById('newListName').value; const icon=document.getElementById('newListIcon').value; if(name.trim()) addNewList(name, icon);"
                        class="px-6 py-3 bg-gray-700 text-white rounded-xl font-medium active:bg-gray-800">
                  å»ºç«‹
                </button>
              </div>
            </div>
          </div>

          <!-- åº•éƒ¨ï¼šç‰©å“åº«å…¥å£ -->
          <div class="p-4 bg-white border-t border-gray-200 safe-bottom">
            <button onclick="currentView='library'; render();"
                    class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-medium active:bg-gray-50">
              ğŸ“š ç®¡ç†ç‰©å“åº«
            </button>
          </div>
        </div>
      `;
    }

    function renderLibraryView() {
      const groupedItems = {};
      categories.forEach(cat => { groupedItems[cat] = []; });
      state.itemLibrary.forEach(item => {
        if (groupedItems[item.category]) {
          groupedItems[item.category].push(item);
        }
      });

      return `
        <div class="flex flex-col h-screen">
          <!-- é ‚éƒ¨ -->
          <div class="bg-gray-700 text-white px-4 py-3">
            <div class="flex items-center justify-between">
              <button onclick="currentView='lists'; render();" class="p-2 -ml-2 rounded-lg hover:bg-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
              </button>
              <div class="text-lg font-bold">ğŸ“š ç‰©å“åº«</div>
              <div class="w-10"></div>
            </div>
          </div>

          <!-- æ–°å¢ç‰©å“ -->
          <div class="p-4 bg-gray-50 border-b border-gray-200">
            <div class="text-sm text-gray-500 mb-2">æ–°å¢ç‰©å“</div>
            <input type="text" id="newItemName" placeholder="ç‰©å“åç¨±..."
                   class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-2 focus:outline-none focus:border-gray-500">
            <select id="newItemCategory"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-2 bg-white focus:outline-none focus:border-gray-500">
              ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
            </select>
            <input type="text" id="newItemNote" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰ï¼šå­˜æ”¾ä½ç½®ã€æé†’äº‹é …..."
                   class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-2 text-gray-600 focus:outline-none focus:border-gray-500">
            <button onclick="const name=document.getElementById('newItemName').value; const cat=document.getElementById('newItemCategory').value; const note=document.getElementById('newItemNote').value; if(name.trim()){ addItemToLibrary(name,cat,note); document.getElementById('newItemName').value=''; document.getElementById('newItemNote').value=''; }"
                    class="w-full py-3 bg-gray-700 text-white rounded-xl font-medium active:bg-gray-800">
              + æ–°å¢ç‰©å“
            </button>
          </div>

          <!-- ç‰©å“åˆ—è¡¨ -->
          <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
            ${categories.map(category => {
              const items = groupedItems[category];
              if (items.length === 0) return '';
              return `
                <div class="mb-4">
                  <div class="text-sm text-gray-500 font-medium mb-2">${category}</div>
                  <div class="space-y-2">
                    ${items.map(item => `
                      <div class="p-3 bg-white rounded-xl shadow-sm">
                        <div class="flex items-center justify-between">
                          <span class="font-medium text-gray-800">${item.name}</span>
                          <div class="flex gap-2">
                            <button onclick="editingItemId=${item.id}; render();" class="text-sm text-gray-400 px-2">ç·¨è¼¯</button>
                            <button onclick="if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) deleteItemFromLibrary(${item.id});" class="text-sm text-red-400 px-2">åˆªé™¤</button>
                          </div>
                        </div>
                        ${item.note ? `<div class="text-sm text-gray-400 mt-1">ğŸ“ ${item.note}</div>` : ''}
                      </div>
                    `).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- ç·¨è¼¯å½ˆçª— -->
        ${editingItemId ? (() => {
          const item = state.itemLibrary.find(i => i.id === editingItemId);
          if (!item) return '';
          return `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50" onclick="editingItemId=null; render();">
              <div class="bg-white w-full max-w-lg rounded-t-2xl p-6 safe-bottom" onclick="event.stopPropagation();">
                <div class="text-lg font-bold mb-4">ç·¨è¼¯ç‰©å“</div>
                <input type="text" id="editItemName" value="${item.name}"
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-2 focus:outline-none focus:border-gray-500">
                <select id="editItemCategory"
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-2 bg-white focus:outline-none focus:border-gray-500">
                  ${categories.map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                </select>
                <input type="text" id="editItemNote" value="${item.note || ''}" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰"
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-4 focus:outline-none focus:border-gray-500">
                <div class="flex gap-3">
                  <button onclick="editingItemId=null; render();"
                          class="flex-1 py-3 border border-gray-300 rounded-xl font-medium">å–æ¶ˆ</button>
                  <button onclick="updateItem(${item.id}, document.getElementById('editItemName').value, document.getElementById('editItemCategory').value, document.getElementById('editItemNote').value);"
                          class="flex-1 py-3 bg-gray-700 text-white rounded-xl font-medium">å„²å­˜</button>
                </div>
              </div>
            </div>
          `;
        })() : ''}
      `;
    }

    function renderAddItemsView() {
      const list = getActiveList();
      const groupedItems = {};
      categories.forEach(cat => { groupedItems[cat] = []; });
      state.itemLibrary.forEach(item => {
        if (groupedItems[item.category]) {
          groupedItems[item.category].push(item);
        }
      });

      return `
        <div class="flex flex-col h-screen">
          <!-- é ‚éƒ¨ -->
          <div class="bg-gray-700 text-white px-4 py-3">
            <div class="flex items-center justify-between">
              <button onclick="currentView='checklist'; render();" class="p-2 -ml-2 rounded-lg hover:bg-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
              </button>
              <div class="text-lg font-bold">åŠ å…¥ç‰©å“</div>
              <div class="w-10"></div>
            </div>
            <div class="text-sm text-gray-300 mt-1">é¸æ“‡è¦åŠ å…¥ã€Œ${list?.name}ã€çš„ç‰©å“</div>
          </div>

          <!-- ç‰©å“é¸æ“‡ -->
          <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
            ${categories.map(category => {
              const items = groupedItems[category];
              if (items.length === 0) return '';
              return `
                <div class="mb-4">
                  <div class="text-sm text-gray-500 font-medium mb-2">${category}</div>
                  <div class="space-y-2">
                    ${items.map(item => {
                      const isInList = list?.items.includes(item.id);
                      return `
                        <div onclick="toggleItemInList(${item.id})"
                             class="flex items-center p-4 bg-white rounded-xl shadow-sm active:bg-gray-50 ${isInList ? 'ring-2 ring-gray-400' : ''}">
                          <div class="w-6 h-6 border-2 rounded-full mr-4 flex items-center justify-center flex-shrink-0
                                      ${isInList ? 'border-gray-600 bg-gray-600' : 'border-gray-300'}">
                            ${isInList ? '<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>' : ''}
                          </div>
                          <div class="flex-1">
                            <div class="${isInList ? 'text-gray-800 font-medium' : 'text-gray-600'}">${item.name}</div>
                            ${item.note ? `<div class="text-xs text-gray-400 mt-0.5">ğŸ“ ${item.note}</div>` : ''}
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          <!-- åº•éƒ¨ -->
          <div class="p-4 bg-white border-t border-gray-200 safe-bottom">
            <div class="text-center text-gray-500 mb-3">å·²é¸æ“‡ ${list?.items?.length || 0} å€‹ç‰©å“</div>
            <button onclick="currentView='checklist'; render();"
                    class="w-full py-3 bg-gray-700 text-white rounded-xl font-medium active:bg-gray-800">
              å®Œæˆ
            </button>
          </div>
        </div>
      `;
    }

    function attachEventListeners() {
      // å¦‚æœéœ€è¦é¡å¤–çš„äº‹ä»¶ç›£è½å™¨
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PWA Service Worker è¨»å†Š
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed', err));
      });
    }

    // åˆå§‹æ¸²æŸ“
    render();
  </script>
</body>
</html>
